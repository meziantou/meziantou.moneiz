@using Meziantou.Moneiz.Core
@using Meziantou.Moneiz.Services
@inherits InputBase<Category?>
@inject DatabaseProvider DatabaseProvider

<InputSelectFilterable 
    TItem="Category"
    @bind-Value="CurrentValue"
    Items="@(_database?.Categories ?? Enumerable.Empty<Category>())"
    GetItemId="@(c => c?.Id.ToString(System.Globalization.CultureInfo.InvariantCulture))"
    ParseItemId="@ParseCategoryId"
    GetItemDisplayName="@(c => c.Name ?? "")"
    GetGroupName="@(c => c.GroupName ?? "")"
    GetSearchableText="@GetSearchableText"
    AreItemsEqual="@((c1, c2) => c1?.Id == c2?.Id)"
    AllowEmpty="@IsOptional"
    EmptyText="(None)"
    EmptyResultsText="No categories found"
    SearchPlaceholder="Search categories..."
    EmptySelectionText="Select a category..."
    ComponentCssClass="input-select-category"
    @attributes="AdditionalAttributes" />

@code {
    private Database? _database;

    [Parameter]
    public bool IsOptional { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _database = await DatabaseProvider.GetDatabase();
    }

    protected override string? FormatValueAsString(Category? value) 
        => value?.Id.ToString(System.Globalization.CultureInfo.InvariantCulture);

    protected override bool TryParseValueFromString(string? value, [MaybeNullWhen(false)] out Category? result, [NotNullWhen(false)] out string? validationErrorMessage)
    {
        if (int.TryParse(value, System.Globalization.NumberStyles.Integer, System.Globalization.CultureInfo.InvariantCulture, out var resultInt))
        {
            System.Diagnostics.Debug.Assert(_database is not null);
            result = _database.GetCategoryById(resultInt);
            validationErrorMessage = null;
            return true;
        }
        else
        {
            if (IsOptional)
            {
                result = null;
                validationErrorMessage = null;
                return true;
            }

            result = default;
            validationErrorMessage = "The chosen value is not a valid number.";
            return false;
        }
    }

    private Category? ParseCategoryId(string? value)
    {
        if (int.TryParse(value, System.Globalization.NumberStyles.Integer, System.Globalization.CultureInfo.InvariantCulture, out var id))
        {
            return _database?.GetCategoryById(id);
        }
        return null;
    }

    private string GetSearchableText(Category category)
    {
        return string.IsNullOrEmpty(category.GroupName)
            ? category.Name ?? ""
            : $"{category.GroupName}::{category.Name}";
    }
}
