@using Meziantou.Moneiz.Core
@using Meziantou.Moneiz.Services
@inherits InputBase<Account?>
@inject DatabaseProvider DatabaseProvider

<InputSelectFilterable 
    TItem="Account"
    @bind-Value="CurrentValue"
    Items="@(_database?.VisibleAccounts ?? Enumerable.Empty<Account>())"
    GetItemId="@(a => a?.Id.ToString(System.Globalization.CultureInfo.InvariantCulture))"
    ParseItemId="@ParseAccountId"
    GetItemDisplayName="@(a => a.Name ?? "")"
    GetGroupName="@(a => a.Bank ?? "")"
    GetSearchableText="@GetSearchableText"
    AreItemsEqual="@((a1, a2) => a1?.Id == a2?.Id)"
    AllowEmpty="false"
    EmptyResultsText="No accounts found"
    SearchPlaceholder="Search accounts..."
    EmptySelectionText="Select an account..."
    ComponentCssClass="input-select-account"
    @attributes="AdditionalAttributes" />

@code {
    private Database? _database;

    protected override async Task OnInitializedAsync()
    {
        _database = await DatabaseProvider.GetDatabase();
    }

    protected override string? FormatValueAsString(Account? value) 
        => value?.Id.ToString(System.Globalization.CultureInfo.InvariantCulture);

    protected override bool TryParseValueFromString(string? value, [MaybeNullWhen(false)] out Account? result, [NotNullWhen(false)] out string? validationErrorMessage)
    {
        if (int.TryParse(value, System.Globalization.NumberStyles.Integer, System.Globalization.CultureInfo.InvariantCulture, out var resultInt))
        {
            System.Diagnostics.Debug.Assert(_database is not null);
            result = _database.GetAccountById(resultInt);
            validationErrorMessage = null;
            return true;
        }
        else
        {
            result = default;
            validationErrorMessage = "The chosen value is not a valid number.";
            return false;
        }
    }

    private Account? ParseAccountId(string? value)
    {
        if (int.TryParse(value, System.Globalization.NumberStyles.Integer, System.Globalization.CultureInfo.InvariantCulture, out var id))
        {
            return _database?.GetAccountById(id);
        }
        return null;
    }

    private string GetSearchableText(Account account)
    {
        return string.IsNullOrEmpty(account.Bank)
            ? account.Name ?? ""
            : $"{account.Bank}::{account.Name}";
    }
}
