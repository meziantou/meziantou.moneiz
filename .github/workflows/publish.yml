name: CI

on:
  push:

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  OUTPUT: output

defaults:
  run:
    shell: pwsh

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v5

    - name: Install WASM workload
      run: dotnet workload install wasm-tools

    - name: Exchange rates
      run: 'dotnet run --project src/Meziantou.Moneiz.ExchangeRatesGenerator -- src/Meziantou.Moneiz.Core/Database.Currencies.generated.cs "${{ secrets.OPENEXCHANGERATES_APIKEY }}"'

    - name: Test
      run: dotnet test

  deploy-site:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v5

    - name: Install WASM workload
      run: dotnet workload install wasm-tools

    - name: Exchange rates
      run: 'dotnet run --project src/Meziantou.Moneiz.ExchangeRatesGenerator -- src/Meziantou.Moneiz.Core/Database.Currencies.generated.cs "${{ secrets.OPENEXCHANGERATES_APIKEY }}"'

    - name: Publish
      run: dotnet publish src/Meziantou.Moneiz/Meziantou.Moneiz.csproj --configuration Release --output ${{ env.OUTPUT }} /bl

    - uses: actions/upload-artifact@v6
      if: always()
      with:
        name: binlog
        path: "**/*.binlog"

    - name: Copy staticwebapp.config.json file
      run: cp src/Meziantou.Moneiz/staticwebapp.config.json ${{ env.OUTPUT }}/wwwroot/staticwebapp.config.json

    - name: Build And Deploy
      if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
      id: builddeploy
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "${{ env.OUTPUT }}/wwwroot/"
        output_location: ''
        skip_app_build: true

  publish-cli:
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      id-token: write
    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v5

    - name: Pack CLI tool
      run: dotnet pack src/Meziantou.Moneiz.Cli/Meziantou.Moneiz.Cli.csproj --configuration Release --output nupkg

    - name: Upload CLI package artifact
      uses: actions/upload-artifact@v6
      with:
        name: cli-package
        path: nupkg/*.nupkg

    - name: NuGet login (OIDC â†’ temp API key)
      uses: NuGet/login@v1
      id: login
      with:
        user: meziantou

    - name: Publish CLI tool to NuGet
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: dotnet nuget push nupkg/*.nupkg --api-key ${{steps.login.outputs.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json --skip-duplicate
